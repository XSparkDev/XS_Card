{
  "info": {
    "name": "XSCard Events QR Code Check-in System API",
    "description": "Comprehensive test collection for the QR code check-in system backend implementation",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.1"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{authToken}}",
        "type": "string"
      }
    ]
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8383/api",
      "type": "string"
    },
    {
      "key": "authToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "attendeeToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "eventId",
      "value": "",
      "type": "string"
    },
    {
      "key": "ticketId",
      "value": "",
      "type": "string"
    },
    {
      "key": "userId",
      "value": "",
      "type": "string"
    },
    {
      "key": "organizerId",
      "value": "",
      "type": "string"
    },
    {
      "key": "verificationToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "qrDataString",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. Authentication & Setup",
      "item": [
        {
          "name": "Login as Organizer",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.success && response.token) {",
                  "        pm.collectionVariables.set('authToken', response.token);",
                  "        pm.collectionVariables.set('organizerId', response.user.uid);",
                  "        console.log('Auth token set:', response.token);",
                  "        console.log('Organizer ID set:', response.user.uid);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"testehakke@gufum.com\",\n  \"password\": \"123456\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "auth",
                "login"
              ]
            }
          }
        },
        {
          "name": "Login as Attendee",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.success && response.token) {",
                  "        pm.collectionVariables.set('attendeeToken', response.token);",
                  "        pm.collectionVariables.set('userId', response.user.uid);",
                  "        console.log('Attendee token set:', response.token);",
                  "        console.log('User ID set:', response.user.uid);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"email\": \"pule@xspark.co.za\",\n  \"password\": \"P.zzle$0\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/auth/login",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "auth",
                "login"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "2. Event Management",
      "item": [
        {
          "name": "Create Test Event",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    if (response.success && response.event) {",
                  "        pm.collectionVariables.set('eventId', response.event.id);",
                  "        console.log('Event ID set:', response.event.id);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"title\": \"QR Code Test Event\",\n  \"description\": \"Test event for QR code check-in system\",\n  \"eventDate\": \"2025-07-15T10:00:00.000Z\",\n  \"endDate\": \"2025-07-15T18:00:00.000Z\",\n  \"location\": {\n    \"venue\": \"Test Venue\",\n    \"address\": \"123 Test Street\",\n    \"city\": \"Test City\",\n    \"country\": \"Test Country\"\n  },\n  \"category\": \"technology\",\n  \"eventType\": \"free\",\n  \"ticketPrice\": 0,\n  \"maxAttendees\": 100,\n  \"visibility\": \"public\",\n  \"tags\": [\"qr-code\", \"testing\"]\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/events",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events"
              ]
            }
          }
        },
        {
          "name": "Publish Event",
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/events/{{eventId}}/publish",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "{{eventId}}",
                "publish"
              ]
            }
          }
        },
        {
          "name": "Register for Event (as Attendee)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Switch to attendee token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('attendeeToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const response = pm.response.json();",
                  "    if (response.success && response.ticket) {",
                  "        pm.collectionVariables.set('ticketId', response.ticket.id);",
                  "        console.log('Ticket ID set:', response.ticket.id);",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"specialRequests\": \"No special requests for QR testing\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/events/{{eventId}}/register",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "{{eventId}}",
                "register"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "3. QR Code Generation",
      "item": [
        {
          "name": "Generate QR Code for Ticket",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Switch to attendee token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('attendeeToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const response = pm.response.json();",
                  "    if (response.success) {",
                  "        pm.collectionVariables.set('verificationToken', response.verificationToken);",
                  "        console.log('Verification token set:', response.verificationToken);",
                  "        ",
                  "        // Create QR data for testing - store as string to avoid escaping issues",
                  "        const qrData = {",
                  "            eventId: pm.collectionVariables.get('eventId'),",
                  "            userId: pm.collectionVariables.get('userId'),",
                  "            ticketId: pm.collectionVariables.get('ticketId'),",
                  "            verificationToken: response.verificationToken,",
                  "            timestamp: Date.now(),",
                  "            type: 'event_checkin',",
                  "            version: '1.0'",
                  "        };",
                  "        ",
                  "        pm.collectionVariables.set('qrDataString', JSON.stringify(qrData));",
                  "        console.log('QR Data set for testing:', JSON.stringify(qrData));",
                  "    }",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/tickets/{{ticketId}}/qr",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "tickets",
                "{{ticketId}}",
                "qr"
              ]
            }
          }
        },
        {
          "name": "Generate Bulk QR Codes for Event",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Switch back to organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/events/{{eventId}}/qr/bulk",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "{{eventId}}",
                "qr",
                "bulk"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "4. QR Code Validation & Check-in",
      "item": [
        {
          "name": "Validate QR Code",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Ensure using organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});",
                  "",
                  "// Set the request body with proper QR data",
                  "const qrDataString = pm.collectionVariables.get('qrDataString');",
                  "pm.request.body.raw = JSON.stringify({",
                  "    qrData: qrDataString",
                  "});",
                  "console.log('Request body set to:', pm.request.body.raw);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"qrData\": \"placeholder - will be set by pre-request script\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/events/qr/validate",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "qr",
                "validate"
              ]
            }
          }
        },
        {
          "name": "Process Check-in",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Ensure using organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});",
                  "",
                  "// Set the request body with proper QR data",
                  "const qrDataString = pm.collectionVariables.get('qrDataString');",
                  "pm.request.body.raw = JSON.stringify({",
                  "    qrData: qrDataString",
                  "});",
                  "console.log('Request body set to:', pm.request.body.raw);"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"qrData\": \"placeholder - will be set by pre-request script\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/events/qr/checkin",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "qr",
                "checkin"
              ]
            }
          }
        },
        {
          "name": "Attempt Double Check-in (Should Fail)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Ensure using organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});",
                  "",
                  "// Set the request body with proper QR data",
                  "const qrDataString = pm.collectionVariables.get('qrDataString');",
                  "pm.request.body.raw = JSON.stringify({",
                  "    qrData: qrDataString",
                  "});",
                  "console.log('Request body set to:', pm.request.body.raw);"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// This should return an error",
                  "pm.test('Should fail with already used error', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([400, 409]);",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.success).to.be.false;",
                  "    pm.expect(response.error).to.be.oneOf(['ALREADY_USED', 'ALREADY_CHECKED_IN']);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"qrData\": \"placeholder - will be set by pre-request script\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/events/qr/checkin",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "qr",
                "checkin"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "5. Event Management & Statistics",
      "item": [
        {
          "name": "Get Event Attendees",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Ensure using organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/events/{{eventId}}/attendees",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "{{eventId}}",
                "attendees"
              ]
            }
          }
        },
        {
          "name": "Get Check-in Statistics",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Ensure using organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/events/{{eventId}}/checkin/stats",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "{{eventId}}",
                "checkin",
                "stats"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "6. Error Testing",
      "item": [
        {
          "name": "Validate Invalid QR Code",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Ensure using organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Should fail with invalid format error', function () {",
                  "    pm.expect(pm.response.code).to.equal(400);",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.success).to.be.false;",
                  "    pm.expect(response.error).to.equal('INVALID_QR_FORMAT');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"qrData\": \"invalid-qr-code-data\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/events/qr/validate",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "qr",
                "validate"
              ]
            }
          }
        },
        {
          "name": "Validate Expired QR Code",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Create expired QR data",
                  "const expiredQrData = {",
                  "    eventId: pm.collectionVariables.get('eventId'),",
                  "    userId: pm.collectionVariables.get('userId'),",
                  "    ticketId: 'fake-ticket-id',",
                  "    verificationToken: 'fake-token',",
                  "    timestamp: Date.now() - (25 * 60 * 60 * 1000), // 25 hours ago",
                  "    type: 'event_checkin',",
                  "    version: '1.0'",
                  "};",
                  "",
                  "pm.request.body.raw = JSON.stringify({",
                  "    qrData: JSON.stringify(expiredQrData)",
                  "});",
                  "",
                  "// Ensure using organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Should fail with token not found', function () {",
                  "    pm.expect(pm.response.code).to.equal(400);",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.success).to.be.false;",
                  "    pm.expect(response.error).to.be.oneOf(['INVALID_TOKEN', 'EXPIRED_TOKEN']);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"qrData\": \"placeholder - will be set by pre-request script\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/events/qr/validate",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "qr",
                "validate"
              ]
            }
          }
        },
        {
          "name": "Unauthorized Check-in Attempt",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Switch to attendee token (should not have organizer permissions)",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('attendeeToken')",
                  "});",
                  "",
                  "// Set the request body with proper QR data",
                  "const qrDataString = pm.collectionVariables.get('qrDataString');",
                  "pm.request.body.raw = JSON.stringify({",
                  "    qrData: qrDataString",
                  "});",
                  "console.log('Request body set to:', pm.request.body.raw);"
                ],
                "type": "text/javascript"
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Should fail with unauthorized error', function () {",
                  "    pm.expect(pm.response.code).to.equal(400);",
                  "    const response = pm.response.json();",
                  "    pm.expect(response.success).to.be.false;",
                  "    pm.expect(response.error).to.equal('UNAUTHORIZED_ORGANIZER');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"qrData\": \"placeholder - will be set by pre-request script\"\n}"
            },
            "url": {
              "raw": "{{baseUrl}}/events/qr/validate",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "qr",
                "validate"
              ]
            }
          }
        }
      ]
    },
    {
      "name": "7. Cleanup",
      "item": [
        {
          "name": "Unregister from Event",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Switch to attendee token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('attendeeToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/events/{{eventId}}/unregister",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "{{eventId}}",
                "unregister"
              ]
            }
          }
        },
        {
          "name": "Delete Test Event",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Remove any existing Authorization header first",
                  "pm.request.removeHeader('Authorization');",
                  "// Switch back to organizer token",
                  "pm.request.headers.add({",
                  "    key: 'Authorization',",
                  "    value: 'Bearer ' + pm.collectionVariables.get('authToken')",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "DELETE",
            "header": [],
            "url": {
              "raw": "{{baseUrl}}/events/{{eventId}}",
              "host": [
                "{{baseUrl}}"
              ],
              "path": [
                "events",
                "{{eventId}}"
              ]
            }
          }
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Global pre-request script",
          "console.log('Running request:', pm.info.requestName);",
          "",
          "// Only set default auth token if no Authorization header is already set",
          "if (!pm.request.headers.has('Authorization') && pm.collectionVariables.get('authToken')) {",
          "    pm.request.headers.add({",
          "        key: 'Authorization',",
          "        value: 'Bearer ' + pm.collectionVariables.get('authToken')",
          "    });",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Global test script",
          "console.log('Response code:', pm.response.code);",
          "console.log('Response time:', pm.response.responseTime + 'ms');",
          "",
          "// Basic response structure tests",
          "pm.test('Response time is acceptable', function () {",
          "    pm.expect(pm.response.responseTime).to.be.below(10000);",
          "});",
          "",
          "pm.test('Response has proper JSON structure', function () {",
          "    try {",
          "        const response = pm.response.json();",
          "        pm.expect(response).to.have.property('success');",
          "    } catch (e) {",
          "        // Some responses might not be JSON, skip this test",
          "        console.log('Response is not JSON, skipping structure test');",
          "    }",
          "});"
        ]
      }
    }
  ]
}
